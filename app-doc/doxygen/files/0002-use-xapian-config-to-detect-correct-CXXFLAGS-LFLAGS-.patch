From d8a000c4527b38b5ee1eae9fc7be8e8c50fba923 Mon Sep 17 00:00:00 2001
From: zaufi <i.zaufi@gmail.com>
Date: Wed, 25 Dec 2013 21:27:23 +0400
Subject: [PATCH 2/3] use xapian-config to detect (correct) CXXFLAGS/LFLAGS
 when no $XAPIAN (dir) present in environment

---
 addon/doxysearch/doxyindexer.pro.in |  2 +-
 addon/doxysearch/doxysearch.pro.in  |  2 +-
 configure                           | 20 +++++++++++---------
 3 files changed, 13 insertions(+), 11 deletions(-)

diff --git a/addon/doxysearch/doxyindexer.pro.in b/addon/doxysearch/doxyindexer.pro.in
index deeb8f8..775fcb7 100644
--- a/addon/doxysearch/doxyindexer.pro.in
+++ b/addon/doxysearch/doxyindexer.pro.in
@@ -2,7 +2,7 @@ TEMPLATE     =	app.t
 CONFIG       =	console warn_on static release
 HEADERS      =	
 SOURCES      =	doxyindexer.cpp
-LIBS        += -L../../lib -lxapian -lqtools
+LIBS        += -L../../lib -lqtools
 DESTDIR      = 
 OBJECTS_DIR  = ../../objects
 TARGET       = ../../bin/doxyindexer
diff --git a/addon/doxysearch/doxysearch.pro.in b/addon/doxysearch/doxysearch.pro.in
index c860fd1..0f8c42f 100644
--- a/addon/doxysearch/doxysearch.pro.in
+++ b/addon/doxysearch/doxysearch.pro.in
@@ -2,7 +2,7 @@ TEMPLATE     =	app.t
 CONFIG       =	console warn_on debug cgi
 HEADERS      =	
 SOURCES      =	doxysearch.cpp
-LIBS        += -lxapian
+LIBS        += 
 DESTDIR      = 
 OBJECTS_DIR  = ../../objects
 TARGET       = ../../bin/doxysearch.cgi
diff --git a/configure b/configure
index 11c84f7..240eff8 100755
--- a/configure
+++ b/configure
@@ -357,15 +357,17 @@ fi
 if test "$f_search" = YES; then
   if test -z "$XAPIAN"; then
     printf "  Checking for Xapian..."
-    for d in /usr /usr/local /opt/local; do
-      if test -e "$d/include/xapian.h"; then
-        XAPIAN=$d
-        break 2
-      fi
-    done
+    xapian_config=`which xapian-config`
+    if test -n "$xapian_config"; then
+      XAPIAN_CXXFLAGS=`$xapian_config --cxxflags`
+      XAPIAN_LFLAGS=`$xapian_config --libs`
+      XAPIAN=`$xapian_config --version`
+    fi
   else
     if test -e "$XAPIAN/include/xapian.h"; then
       printf "  Detected Xapian via the XAPIAN environment variable..."
+      XAPIAN_CXXFLAGS="-I$XAPIAN/include"
+      XAPIAN_LFLAGS="-L$XAPIAN/lib -lxapian"
     else
       printf "ERROR Detected Xapian via the XAPIAN environment variable..."
       echo ", but $XAPIAN/include/xapian.h does not exist."
@@ -374,7 +376,7 @@ if test "$f_search" = YES; then
     fi
   fi
   if test -z "$XAPIAN"; then
-    echo "XAPIAN not set and xapian.h not found at standard locations!"
+    echo "XAPIAN not set and xapian-config not available or xapian.h not found at standard locations!"
     exit 2;
   fi
   echo using $XAPIAN
@@ -798,8 +800,8 @@ fi
 
 if test "$f_search" = YES; then
   cat >> .tmakeconfig <<EOF
-LIBS += -L$XAPIAN/lib
-INCLUDEPATH += $XAPIAN/include
+TMAKE_CXXFLAGS += $XAPIAN_CXXFLAGS
+TMAKE_LFLAGS   += $XAPIAN_LFLAGS
 EOF
 fi
 
-- 
1.8.5.3

